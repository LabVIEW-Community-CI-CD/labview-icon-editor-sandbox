name: CI Pipeline (Composite)

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
      - develop
      - release/*
      - feature/*
      - hotfix/*
  pull_request:
    branches:
      - main
      - develop
      - release/*
      - feature/*
      - hotfix/*
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:
    inputs:
      dispatch_tag:
        description: "Expected tag for this run (optional, for dispatched builds)"
        required: false
        type: string

jobs:
  verify-checklist-sync:
    name: Verify TRW checklist XLSX is synced with CSV
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Regenerate checklist XLSX from CSV
        run: python3 docs/requirements/sync_trw_csv_to_xlsx.py
      - name: Fail if regeneration changes the workbook
        run: |
          if ! git diff --quiet -- docs/requirements/TRW_Verification_Checklist.xlsx; then
            echo "The XLSX generated from CSV differs from the checked-in version." >&2
            echo "Run docs/requirements/sync_trw_csv_to_xlsx.py and commit the updated XLSX." >&2
            git diff -- docs/requirements/TRW_Verification_Checklist.xlsx
            exit 1
          fi

  test-compute-version-bump:
    name: Test compute-version bump selection (matrix)
    needs: [verify-checklist-sync, enforce-verify-checklist-needs]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: none-defaults-to-patch
            labels: ""
            expected: patch
            should_fail: false
            ref: refs/heads/main
            event_name: pull_request
          - name: major-label
            labels: "major"
            expected: major
            should_fail: false
            ref: refs/heads/main
            event_name: pull_request
          - name: minor-label
            labels: "minor"
            expected: minor
            should_fail: false
            ref: refs/heads/main
            event_name: pull_request
          - name: patch-label
            labels: "patch"
            expected: patch
            should_fail: false
            ref: refs/heads/main
            event_name: pull_request
          - name: multiple-labels-fail
            labels: "major,patch"
            expected: ""
            should_fail: true
            ref: refs/heads/main
            event_name: pull_request
          - name: release-alpha-defaults-patch
            labels: ""
            expected: patch
            should_fail: false
            ref: refs/heads/release-alpha/1.2
            event_name: push
          - name: release-beta-defaults-patch
            labels: ""
            expected: patch
            should_fail: false
            ref: refs/heads/release-beta/1.2
            event_name: push
          - name: release-rc-defaults-patch
            labels: ""
            expected: patch
            should_fail: false
            ref: refs/heads/release-rc/1.2
            event_name: push
          - name: release-defaults-patch
            labels: ""
            expected: patch
            should_fail: false
            ref: refs/heads/release/1.2
            event_name: push
    steps:
      - uses: actions/github-script@v7
        env:
          LABELS: ${{ matrix.labels }}
          EXPECTED: ${{ matrix.expected }}
          SHOULD_FAIL: ${{ matrix.should_fail }}
          REF: ${{ matrix.ref }}
          EVENT_NAME: ${{ matrix.event_name }}
        with:
          script: |
            const labels = (process.env.LABELS || '').split(',').map(s => s.trim()).filter(Boolean);
            const expected = process.env.EXPECTED || '';
            const shouldFail = (process.env.SHOULD_FAIL || 'false').toLowerCase() === 'true';
            const ref = process.env.REF || '';
            const eventName = process.env.EVENT_NAME || 'pull_request';
            const allowed = ['major', 'minor', 'patch'];
            const found = labels.filter(l => allowed.includes(l));
            core.info(`Labels: ${labels.join(', ') || '(none)'} | ref=${ref} | event=${eventName}`);
            core.info(`Allowed labels found: ${found.join(', ') || '(none)'}`);
            if (found.length > 1) {
              if (shouldFail) {
                core.info('Multiple labels detected as expected; computation should fail.');
                return;
              }
              core.setFailed(`Unexpected multiple labels found: ${found.join(', ')}`);
              return;
            }
            const isRelease = /^refs\/heads\/release(-alpha|-beta|-rc)?\//.test(ref);
            let bump = found[0] || 'patch';
            if (eventName !== 'pull_request' && isRelease && !found.length) {
              bump = 'patch';
              core.info('Release branch detected outside PR; bump forced to patch.');
            }
            core.info(`Selected bump: ${bump}; expected: ${expected}`);
            if (shouldFail) {
              core.setFailed(`Expected failure due to multiple labels, but only one/none were present (selected ${bump}).`);
              return;
            }
            if (bump !== expected) {
              core.setFailed(`Bump selection mismatch: expected ${expected}, got ${bump}.`);
            }

  enforce-verify-checklist-needs:
    name: Enforce jobs depend on verify-checklist-sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check job dependencies include verify-checklist-sync
        run: |
          python3 - <<'PY'
          import sys
          try:
            import yaml  # type: ignore
          except ImportError:
            import subprocess
            subprocess.check_call([sys.executable, "-m", "pip", "install", "pyyaml"])
            import yaml  # type: ignore
          from pathlib import Path

          data = yaml.safe_load(Path(".github/workflows/ci-composite.yml").read_text())
          jobs = data.get("jobs", {})
          exempt = {"verify-checklist-sync", "enforce-verify-checklist-needs"}
          missing = []
          for name, job in jobs.items():
            if name in exempt:
              continue
            needs = job.get("needs")
            if needs is None:
              missing.append(name)
              continue
            needs_list = [needs] if isinstance(needs, str) else list(needs)
            if "verify-checklist-sync" not in needs_list:
              missing.append(name)
          if missing:
            print("These jobs must declare needs: verify-checklist-sync ->", ", ".join(sorted(missing)), file=sys.stderr)
            sys.exit(1)
          PY

  changes:
    name: Detect VIPC changes
    needs: [verify-checklist-sync, enforce-verify-checklist-needs]
    runs-on: ubuntu-latest
    outputs:
      vipc: ${{ steps.filter.outputs.vipc }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            vipc:
              - '**/*.vipc'

  apply-deps-2021-x64:
    name: Apply VIPC (2021 x64)
    needs: [verify-checklist-sync, changes]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/apply-vipc
        if: needs.changes.outputs.vipc == 'true'
        with:
          minimum_supported_lv_version: 2021
          vip_lv_version:               2021
          supported_bitness:            64
          relative_path:                ${{ github.workspace }}
          vipc_path:                    ".github/actions/apply-vipc/runner_dependencies.vipc"
      - run: echo "No .vipc changes detected; skipping dependency application."
        if: needs.changes.outputs.vipc != 'true'

  apply-deps-2021-x86:
    name: Apply VIPC (2021 x86)
    needs: [verify-checklist-sync, apply-deps-2021-x64, changes]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/apply-vipc
        if: needs.changes.outputs.vipc == 'true'
        with:
          minimum_supported_lv_version: 2021
          vip_lv_version:               2021
          supported_bitness:            32
          relative_path:                ${{ github.workspace }}
          vipc_path:                    ".github/actions/apply-vipc/runner_dependencies.vipc"
      - run: echo "No .vipc changes detected; skipping dependency application."
        if: needs.changes.outputs.vipc != 'true'

  apply-deps-2023-x64:
    name: Apply VIPC (2023 x64)
    needs: [verify-checklist-sync, close-lv-2021-before-2023, changes]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/apply-vipc
        if: needs.changes.outputs.vipc == 'true'
        with:
          minimum_supported_lv_version: 2023
          vip_lv_version:               2023
          supported_bitness:            64
          relative_path:                ${{ github.workspace }}
          vipc_path:                    ".github/actions/apply-vipc/runner_dependencies.vipc"
      - run: echo "No .vipc changes detected; skipping dependency application."
        if: needs.changes.outputs.vipc != 'true'

  close-lv-2021-before-2023:
    name: Close LabVIEW 2021 before 2023 tasks
    needs: [verify-checklist-sync, apply-deps-2021-x86]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64
      - uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 32

  version:
    name: Compute Version
    needs: [verify-checklist-sync, enforce-verify-checklist-needs]
    runs-on: self-hosted-windows-lv
    outputs:
      VERSION:       ${{ steps.compute.outputs.VERSION }}
      MAJOR:         ${{ steps.compute.outputs.MAJOR }}
      MINOR:         ${{ steps.compute.outputs.MINOR }}
      PATCH:         ${{ steps.compute.outputs.PATCH }}
      BUILD:         ${{ steps.compute.outputs.BUILD }}
      IS_PRERELEASE: ${{ steps.compute.outputs.IS_PRERELEASE }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: compute
        uses: ./.github/actions/compute-version
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  missing-in-project-2021-x64:
    name: Test Missing-In-Project (2021 x64)
    needs: [verify-checklist-sync, apply-deps-2023-x64]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/missing-in-project
        with:
          lv-ver:       "2021"
          arch:         "64"
          project-file: "lv_icon_editor.lvproj"

  missing-in-project-2021-x86:
    name: Test Missing-In-Project (2021 x86)
    needs: [verify-checklist-sync, missing-in-project-2021-x64]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/missing-in-project
        with:
          lv-ver:       "2021"
          arch:         "32"
          project-file: "lv_icon_editor.lvproj"

  test-2021-x64:
    name: Run Unit Tests (2021 x64)
    needs: [verify-checklist-sync, missing-in-project-2021-x86]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/run-unit-tests
        with:
          minimum_supported_lv_version: "2021"
          supported_bitness:            "64"
      - if: always()
        name: Close LabVIEW 2021 64-bit after unit tests
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64

  test-2021-x86:
    name: Run Unit Tests (2021 x86)
    needs: [verify-checklist-sync, test-2021-x64]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/run-unit-tests
        with:
          minimum_supported_lv_version: "2021"
          supported_bitness:            "32"
      - if: always()
        name: Close LabVIEW 2021 32-bit after unit tests
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 32

  build-ppl-x86:
    name: Build 32-bit Packed Library
    needs: [verify-checklist-sync, build-ppl-x64, version]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/build-lvlibp
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 32
          relative_path: ${{ github.workspace }}
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 32
      - uses: ./.github/actions/rename-file
        with:
          current_filename: ${{ github.workspace }}/resource/plugins/lv_icon.lvlibp
          new_filename: ${{ github.workspace }}/resource/plugins/lv_icon_x86.lvlibp
      - uses: actions/upload-artifact@v4
        with:
          name: lv_icon_x86.lvlibp
          path: resource/plugins/lv_icon_x86.lvlibp

  build-ppl-x64:
    name: Build 64-bit Packed Library
    needs: [verify-checklist-sync, test-2021-x86, version]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/build-lvlibp
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64
          relative_path: ${{ github.workspace }}
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64
      - uses: ./.github/actions/rename-file
        with:
          current_filename: ${{ github.workspace }}/resource/plugins/lv_icon.lvlibp
          new_filename: ${{ github.workspace }}/resource/plugins/lv_icon_x64.lvlibp
      - uses: actions/upload-artifact@v4
        with:
          name: lv_icon_x64.lvlibp
          path: resource/plugins/lv_icon_x64.lvlibp

  build-vip:
    name: Build VI Package
    # Chain after 32-bit build, which already depends on 64-bit, to enforce x64 -> x86 -> build-vip ordering
    needs: [verify-checklist-sync, build-ppl-x86, version]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate release notes
        uses: ./.github/actions/generate-release-notes
        # output_path defaults to Tooling/deployment/release_notes.md
      - uses: actions/download-artifact@v4
        with:
          name: lv_icon_x86.lvlibp
          path: resource/plugins
      - uses: actions/download-artifact@v4
        with:
          name: lv_icon_x64.lvlibp
          path: resource/plugins
      - name: Generate display information JSON
        id: display-info
        shell: pwsh
        env:
          RELEASE_NOTES_PATH: ${{ github.workspace }}/Tooling/deployment/release_notes.md
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_DESCRIPTION: ${{ github.event.repository.description }}
          REPO_URL: ${{ github.event.repository.html_url }}
          COMPANY: ${{ github.repository_owner }}
          REPOSITORY: ${{ github.repository }}
        run: |
          $releaseNotes = if (Test-Path $Env:RELEASE_NOTES_PATH) {
            Get-Content -Raw -Path $Env:RELEASE_NOTES_PATH
          } else {
            "Release notes file not generated."
          }

          $productName = if ([string]::IsNullOrWhiteSpace($Env:REPO_NAME)) {
            $Env:REPOSITORY
          } else {
            $Env:REPO_NAME
          }

          $description = if ([string]::IsNullOrWhiteSpace($Env:REPO_DESCRIPTION)) {
            "$($Env:REPO_NAME) VI Package build for $($Env:REPOSITORY)."
          } else {
            $Env:REPO_DESCRIPTION
          }

          $info = @{
            "Package Version" = @{
              "major" = ${{ needs.version.outputs.MAJOR }}
              "minor" = ${{ needs.version.outputs.MINOR }}
              "patch" = ${{ needs.version.outputs.PATCH }}
              "build" = ${{ needs.version.outputs.BUILD }}
            }
            "Product Name" = $productName
            "Company Name" = $Env:COMPANY
            "Author Name (Person or Company)" = $Env:REPOSITORY
            "Product Homepage (URL)" = if ([string]::IsNullOrWhiteSpace($Env:REPO_URL)) {
              "https://github.com/$($Env:REPOSITORY)"
            } else {
              $Env:REPO_URL
            }
            "Legal Copyright" = "Â© $(Get-Date -Format yyyy) $($Env:COMPANY)"
            "License Agreement Name" = "See LICENSE.md"
            "Product Description Summary" = $description
            "Product Description" = $description
            "Release Notes - Change Log" = $releaseNotes
          }

          $json = $info | ConvertTo-Json -Depth 5 -Compress
          "json=$json" >> $Env:GITHUB_OUTPUT
      - uses: ./.github/actions/modify-vipb-display-info
        with:
          supported_bitness: 64
          relative_path: ${{ github.workspace }}
          vipb_path: Tooling/deployment/NI Icon editor.vipb
          minimum_supported_lv_version: 2023
          labview_minor_revision: 3
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
          release_notes_file: ${{ github.workspace }}/Tooling/deployment/release_notes.md
          display_information_json: ${{ steps.display-info.outputs.json }}
      - uses: ./.github/actions/build-vip
        with:
          supported_bitness: 64
          relative_path: ${{ github.workspace }}
          vipb_path: Tooling/deployment/NI Icon editor.vipb
          minimum_supported_lv_version: 2023
          labview_minor_revision: 3
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
          release_notes_file: ${{ github.workspace }}/Tooling/deployment/release_notes.md
          display_information_json: ${{ steps.display-info.outputs.json }}
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2023
          supported_bitness: 64
      - name: Validate tag matches computed version (if provided)
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.dispatch_tag != ''
        shell: pwsh
        env:
          EXPECTED_TAG: v${{ needs.version.outputs.MAJOR }}.${{ needs.version.outputs.MINOR }}.${{ needs.version.outputs.PATCH }}.${{ needs.version.outputs.BUILD }}
          REF_TAG: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          INPUT_TAG: ${{ github.event.inputs.dispatch_tag || '' }}
        run: |
          $ErrorActionPreference = 'Stop'
          $provided = if (-not [string]::IsNullOrWhiteSpace($Env:INPUT_TAG)) { $Env:INPUT_TAG } else { $Env:REF_TAG }
          if ([string]::IsNullOrWhiteSpace($provided)) {
            Write-Host 'No tag provided; skipping validation.'
            exit 0
          }
          if ($provided -ne $Env:EXPECTED_TAG) {
            Write-Error ("Provided tag '{0}' does not match computed tag '{1}'." -f $provided, $Env:EXPECTED_TAG)
          } else {
            Write-Host ("Tag validation ok: {0}" -f $provided)
          }

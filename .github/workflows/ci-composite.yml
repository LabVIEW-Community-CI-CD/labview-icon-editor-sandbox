name: CI Pipeline (Composite)

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
      - develop
      - release/*
      - feature/*
      - hotfix/*
  pull_request:
    branches:
      - main
      - develop
      - release/*
      - feature/*
      - hotfix/*
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:
    inputs:
      dispatch_tag:
        description: "Expected tag for this run (optional, for dispatched builds)"
        required: false
        type: string

jobs:
  changes:
    name: Detect VIPC changes
    runs-on: ubuntu-latest
    outputs:
      vipc: ${{ steps.filter.outputs.vipc }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            vipc:
              - '**/*.vipc'

  apply-deps-2021-x64:
    name: Apply VIPC (2021 x64)
    needs: changes
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/apply-vipc
        if: needs.changes.outputs.vipc == 'true'
        with:
          minimum_supported_lv_version: 2021
          vip_lv_version:               2021
          supported_bitness:            64
          relative_path:                ${{ github.workspace }}
          vipc_path:                    ".github/actions/apply-vipc/runner_dependencies.vipc"
      - run: echo "No .vipc changes detected; skipping dependency application."
        if: needs.changes.outputs.vipc != 'true'

  apply-deps-2021-x86:
    name: Apply VIPC (2021 x86)
    needs: [apply-deps-2021-x64, changes]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/apply-vipc
        if: needs.changes.outputs.vipc == 'true'
        with:
          minimum_supported_lv_version: 2021
          vip_lv_version:               2021
          supported_bitness:            32
          relative_path:                ${{ github.workspace }}
          vipc_path:                    ".github/actions/apply-vipc/runner_dependencies.vipc"
      - run: echo "No .vipc changes detected; skipping dependency application."
        if: needs.changes.outputs.vipc != 'true'

  apply-deps-2023-x64:
    name: Apply VIPC (2023 x64)
    needs: [apply-deps-2021-x86, changes]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/apply-vipc
        if: needs.changes.outputs.vipc == 'true'
        with:
          minimum_supported_lv_version: 2023
          vip_lv_version:               2023
          supported_bitness:            64
          relative_path:                ${{ github.workspace }}
          vipc_path:                    ".github/actions/apply-vipc/runner_dependencies.vipc"
      - run: echo "No .vipc changes detected; skipping dependency application."
        if: needs.changes.outputs.vipc != 'true'

  version:
    name: Compute Version
    runs-on: self-hosted-windows-lv
    outputs:
      VERSION:       ${{ steps.compute.outputs.VERSION }}
      MAJOR:         ${{ steps.compute.outputs.MAJOR }}
      MINOR:         ${{ steps.compute.outputs.MINOR }}
      PATCH:         ${{ steps.compute.outputs.PATCH }}
      BUILD:         ${{ steps.compute.outputs.BUILD }}
      IS_PRERELEASE: ${{ steps.compute.outputs.IS_PRERELEASE }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: compute
        uses: ./.github/actions/compute-version
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  missing-in-project-2021-x64:
    name: Test Missing-In-Project (2021 x64)
    needs: apply-deps-2023-x64
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/missing-in-project
        with:
          lv-ver:       "2021"
          arch:         "64"
          project-file: "lv_icon_editor.lvproj"

  missing-in-project-2021-x86:
    name: Test Missing-In-Project (2021 x86)
    needs: missing-in-project-2021-x64
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/missing-in-project
        with:
          lv-ver:       "2021"
          arch:         "32"
          project-file: "lv_icon_editor.lvproj"

  test-2021-x64:
    name: Run Unit Tests (2021 x64)
    needs: missing-in-project-2021-x86
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/run-unit-tests
        with:
          minimum_supported_lv_version: "2021"
          supported_bitness:            "64"

  test-2021-x86:
    name: Run Unit Tests (2021 x86)
    needs: test-2021-x64
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/run-unit-tests
        with:
          minimum_supported_lv_version: "2021"
          supported_bitness:            "32"

  build-ppl-x86:
    name: Build 32-bit Packed Library
    needs: [build-ppl-x64, version]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/build-lvlibp
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 32
          relative_path: ${{ github.workspace }}
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 32
      - uses: ./.github/actions/rename-file
        with:
          current_filename: ${{ github.workspace }}/resource/plugins/lv_icon.lvlibp
          new_filename: ${{ github.workspace }}/resource/plugins/lv_icon_x86.lvlibp
      - uses: actions/upload-artifact@v4
        with:
          name: lv_icon_x86.lvlibp
          path: resource/plugins/lv_icon_x86.lvlibp

  build-ppl-x64:
    name: Build 64-bit Packed Library
    needs: [test-2021-x86, version]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: ./.github/actions/build-lvlibp
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64
          relative_path: ${{ github.workspace }}
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64
      - uses: ./.github/actions/rename-file
        with:
          current_filename: ${{ github.workspace }}/resource/plugins/lv_icon.lvlibp
          new_filename: ${{ github.workspace }}/resource/plugins/lv_icon_x64.lvlibp
      - uses: actions/upload-artifact@v4
        with:
          name: lv_icon_x64.lvlibp
          path: resource/plugins/lv_icon_x64.lvlibp

  build-vip:
    name: Build VI Package
    # Chain after 32-bit build, which already depends on 64-bit, to enforce x64 -> x86 -> build-vip ordering
    needs: [build-ppl-x86, version]
    runs-on: self-hosted-windows-lv
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate release notes
        uses: ./.github/actions/generate-release-notes
        # output_path defaults to Tooling/deployment/release_notes.md
      - uses: actions/download-artifact@v4
        with:
          name: lv_icon_x86.lvlibp
          path: resource/plugins
      - uses: actions/download-artifact@v4
        with:
          name: lv_icon_x64.lvlibp
          path: resource/plugins
      - name: Generate display information JSON
        id: display-info
        shell: pwsh
        env:
          RELEASE_NOTES_PATH: ${{ github.workspace }}/Tooling/deployment/release_notes.md
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_DESCRIPTION: ${{ github.event.repository.description }}
          REPO_URL: ${{ github.event.repository.html_url }}
          COMPANY: ${{ github.repository_owner }}
          REPOSITORY: ${{ github.repository }}
        run: |
          $releaseNotes = if (Test-Path $Env:RELEASE_NOTES_PATH) {
            Get-Content -Raw -Path $Env:RELEASE_NOTES_PATH
          } else {
            "Release notes file not generated."
          }

          $productName = if ([string]::IsNullOrWhiteSpace($Env:REPO_NAME)) {
            $Env:REPOSITORY
          } else {
            $Env:REPO_NAME
          }

          $description = if ([string]::IsNullOrWhiteSpace($Env:REPO_DESCRIPTION)) {
            "$($Env:REPO_NAME) VI Package build for $($Env:REPOSITORY)."
          } else {
            $Env:REPO_DESCRIPTION
          }

          $info = @{
            "Package Version" = @{
              "major" = ${{ needs.version.outputs.MAJOR }}
              "minor" = ${{ needs.version.outputs.MINOR }}
              "patch" = ${{ needs.version.outputs.PATCH }}
              "build" = ${{ needs.version.outputs.BUILD }}
            }
            "Product Name" = $productName
            "Company Name" = $Env:COMPANY
            "Author Name (Person or Company)" = $Env:REPOSITORY
            "Product Homepage (URL)" = if ([string]::IsNullOrWhiteSpace($Env:REPO_URL)) {
              "https://github.com/$($Env:REPOSITORY)"
            } else {
              $Env:REPO_URL
            }
            "Legal Copyright" = "Â© $(Get-Date -Format yyyy) $($Env:COMPANY)"
            "License Agreement Name" = "See LICENSE.md"
            "Product Description Summary" = $description
            "Product Description" = $description
            "Release Notes - Change Log" = $releaseNotes
          }

          $json = $info | ConvertTo-Json -Depth 5 -Compress
          "json=$json" >> $Env:GITHUB_OUTPUT
      - uses: ./.github/actions/modify-vipb-display-info
        with:
          supported_bitness: 64
          relative_path: ${{ github.workspace }}
          vipb_path: Tooling/deployment/NI Icon editor.vipb
          minimum_supported_lv_version: 2023
          labview_minor_revision: 3
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
          release_notes_file: ${{ github.workspace }}/Tooling/deployment/release_notes.md
          display_information_json: ${{ steps.display-info.outputs.json }}
      - uses: ./.github/actions/build-vip
        with:
          supported_bitness: 64
          relative_path: ${{ github.workspace }}
          vipb_path: Tooling/deployment/NI Icon editor.vipb
          minimum_supported_lv_version: 2023
          labview_minor_revision: 3
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
          release_notes_file: ${{ github.workspace }}/Tooling/deployment/release_notes.md
          display_information_json: ${{ steps.display-info.outputs.json }}
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: 64
      - if: always()
        uses: ./.github/actions/close-labview
        with:
          minimum_supported_lv_version: 2023
          supported_bitness: 64
      - name: Validate tag matches computed version (if provided)
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.dispatch_tag != ''
        shell: pwsh
        env:
          EXPECTED_TAG: v${{ needs.version.outputs.MAJOR }}.${{ needs.version.outputs.MINOR }}.${{ needs.version.outputs.PATCH }}.${{ needs.version.outputs.BUILD }}
          REF_TAG: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          INPUT_TAG: ${{ github.event.inputs.dispatch_tag || '' }}
        run: |
          $ErrorActionPreference = 'Stop'
          $provided = if (-not [string]::IsNullOrWhiteSpace($Env:INPUT_TAG)) { $Env:INPUT_TAG } else { $Env:REF_TAG }
          if ([string]::IsNullOrWhiteSpace($provided)) {
            Write-Error "No provided tag (ref/input) to validate against computed tag $Env:EXPECTED_TAG."
          }
          if ($provided -ne $Env:EXPECTED_TAG) {
            Write-Error ("Provided tag '{0}' does not match computed tag '{1}'." -f $provided, $Env:EXPECTED_TAG)
          } else {
            Write-Host ("Tag validation ok: {0}" -f $provided)
          }
      - name: Locate release assets
        if: startsWith(github.ref, 'refs/tags/v')
        id: release-assets
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $vip = Get-ChildItem -Path "$Env:GITHUB_WORKSPACE/builds/VI Package" -Filter *.vip -File -Recurse | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $vip) { Write-Error "No .vip file found for release upload."; exit 1 }

          $notes = Get-ChildItem -Path "$Env:GITHUB_WORKSPACE/Tooling/deployment" -Filter "release_notes_*.md" -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $notes) { Write-Error "No versioned release notes file found for release upload."; exit 1 }

          "vip_path=$($vip.FullName)"           | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          "vip_name=$($vip.Name)"               | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          "notes_path=$($notes.FullName)"       | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          "notes_name=$($notes.Name)"           | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
      - name: Upload .vip to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.release-assets.outputs.vip_path }}
          asset_name: ${{ steps.release-assets.outputs.vip_name }}
          asset_content_type: application/octet-stream
      - name: Upload release notes to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.release-assets.outputs.notes_path }}
          asset_name: ${{ steps.release-assets.outputs.notes_name }}
          asset_content_type: text/markdown

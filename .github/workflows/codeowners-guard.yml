name: CODEOWNERS Guard

defaults:
  run:
    working-directory: ${{ github.workspace }}

on:
  pull_request:
    branches:
      - main
      - develop
      - release/*
      - feature/*
      - hotfix/*
  push:
    branches:
      - main
      - develop
      - release/*

jobs:
  validate:
    name: Validate CODEOWNERS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          set-safe-directory: true
      - name: Ensure CODEOWNERS exists and has required owners
        shell: bash
        run: |
          set -euo pipefail
          file=".github/CODEOWNERS"
          if [[ ! -f "$file" ]]; then
            echo "Missing $file" >&2
            exit 1
          fi
          if [[ ! -s "$file" ]]; then
            echo "$file is empty" >&2
            exit 1
          fi
          declare -a required=(
            '*'
            '/.github/'
            '/docs/'
          )
          esc() {
            # Escape regex metacharacters for grep -E
            printf '%s' "$1" | sed -e 's/[]\\.^$|?*+(){}[]/\\&/g'
          }
          for pat in "${required[@]}"; do
            regex="^$(esc "$pat")[[:space:]]+@"
            if ! grep -Eq "$regex" "$file"; then
              echo "Required pattern '${pat}' with at least one @owner is missing in $file" >&2
              exit 1
            fi
          done
          echo "$file looks valid (default owner and required scoped entries present)."

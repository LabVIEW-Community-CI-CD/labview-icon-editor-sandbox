name: Tag and Release

on:
  push:
    branches:
      - main
      - develop
      - release/*
      - hotfix/*

permissions:
  contents: read
  actions: read

jobs:
  tag-and-release:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: write
      actions: write
    runs-on: self-hosted-windows-lv
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version
        id: version
        uses: ./.github/actions/compute-version
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Form tag
        id: form-tag
        shell: pwsh
        run: |
          $tag = "v${{ steps.version.outputs.MAJOR }}.${{ steps.version.outputs.MINOR }}.${{ steps.version.outputs.PATCH }}.${{ steps.version.outputs.BUILD }}"
          Write-Host "Tag: $tag"
          "tag=$tag" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Ensure ci-composite is green for this commit
        id: ensure_ci
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'
          $repo = $Env:GITHUB_REPOSITORY
          $workflow = "ci-composite.yml"
          $sha = $Env:GITHUB_SHA
          $headers = @{
            Authorization = "Bearer $Env:GITHUB_TOKEN"
            Accept        = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
          }
          $uri = "https://api.github.com/repos/$repo/actions/workflows/$workflow/runs?event=push&head_sha=$sha&status=completed&conclusion=success"
          $response = Invoke-RestMethod -Method Get -Uri $uri -Headers $headers
          if (-not $response.workflow_runs -or $response.workflow_runs.Count -eq 0) {
            Write-Error "No successful ci-composite run found for commit $sha. Aborting tag creation."
          } else {
            $run = $response.workflow_runs[0]
            Write-Host ("Found successful ci-composite run id {0} on branch {1}" -f $run.id, $run.head_branch)
            if ($run.head_sha -ne $sha) {
              Write-Error ("Latest successful ci-composite run ({0}) is for head_sha {1}, not current {2}. Aborting." -f $run.id, $run.head_sha, $sha)
            }
            "run_id=$($run.id)" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          }

      - name: Fail if latest tag matches computed tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ steps.form-tag.outputs.tag }}"
          $latest = git describe --tags --abbrev=0 2>$null
          if ($latest -and $latest -eq $tag) {
            Write-Error ("Computed tag {0} matches latest existing tag. Aborting duplicate tagging." -f $tag)
          } else {
            Write-Host ("Computed tag {0} does not match latest tag {1}. Proceeding." -f $tag, ($latest ?? "<none>"))
          }

      - name: Create tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          $tag = "${{ steps.form-tag.outputs.tag }}"
          git tag $tag
          git push origin $tag

      - name: Download artifacts from successful run
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.ensure_ci.outputs.run_id }}
          path: artifacts

      - name: Locate release assets from artifacts
        id: locate-artifacts
        uses: ./.github/actions/locate-release-assets
        with:
          vip_dir: artifacts
          notes_dir: artifacts

      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.form-tag.outputs.tag }}
          name: ${{ steps.form-tag.outputs.tag }}
          draft: false
          prerelease: false
          body_path: ${{ steps.locate-artifacts.outputs.notes_path }}
          files: |
            ${{ steps.locate-artifacts.outputs.vip_path }}
            ${{ steps.locate-artifacts.outputs.notes_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

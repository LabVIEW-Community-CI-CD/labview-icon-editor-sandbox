name: Tag and Release

on:
  push:
    branches:
      - main
      - develop
      - release/*
      - hotfix/*

permissions:
  contents: read
  actions: read

jobs:
  tag-and-release:
    permissions:
      contents: write
      actions: write
    runs-on: self-hosted-windows-lv
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version
        id: version
        uses: ./.github/actions/compute-version
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Form tag
        id: form-tag
        shell: pwsh
        run: |
          $tag = "v${{ steps.version.outputs.MAJOR }}.${{ steps.version.outputs.MINOR }}.${{ steps.version.outputs.PATCH }}.${{ steps.version.outputs.BUILD }}"
          Write-Host "Tag: $tag"
          "tag=$tag" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Ensure ci-composite is green for this commit
        id: ensure_ci
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'
          $repo = $Env:GITHUB_REPOSITORY
          $workflow = "ci-composite.yml"
          $sha = $Env:GITHUB_SHA
          $headers = @{
            Authorization = "Bearer $Env:GITHUB_TOKEN"
            Accept        = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
          }
          $uri = "https://api.github.com/repos/$repo/actions/workflows/$workflow/runs?event=push&head_sha=$sha&status=completed&conclusion=success"
          $response = Invoke-RestMethod -Method Get -Uri $uri -Headers $headers
          if (-not $response.workflow_runs -or $response.workflow_runs.Count -eq 0) {
            Write-Error "No successful ci-composite run found for commit $sha. Aborting tag creation."
          } else {
            $run = $response.workflow_runs[0]
            Write-Host ("Found successful ci-composite run id {0} on branch {1}" -f $run.id, $run.head_branch)
            if ($run.head_sha -ne $sha) {
              Write-Error ("Latest successful ci-composite run ({0}) is for head_sha {1}, not current {2}. Aborting." -f $run.id, $run.head_sha, $sha)
            }
            "run_id=$($run.id)" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          }

      - name: Fail if latest tag matches computed tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ steps.form-tag.outputs.tag }}"
          $latest = git describe --tags --abbrev=0 2>$null
          if ($latest -and $latest -eq $tag) {
            Write-Error ("Computed tag {0} matches latest existing tag. Aborting duplicate tagging." -f $tag)
          } else {
            Write-Host ("Computed tag {0} does not match latest tag {1}. Proceeding." -f $tag, ($latest ?? "<none>"))
          }

      - name: Create tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          $tag = "${{ steps.form-tag.outputs.tag }}"
          if (git rev-parse --verify --quiet $tag) {
            Write-Host "Tag $tag already exists; skipping."
            exit 0
          }
          git tag $tag
          git push origin $tag

      - name: Download artifacts from successful run
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.ensure_ci.outputs.run_id }}
          path: artifacts

      - name: Locate release assets from artifacts
        id: locate-artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $root = Join-Path -Path $PWD -ChildPath "artifacts"
          $vip = Get-ChildItem -Path $root -Recurse -Filter *.vip -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $vip) { Write-Error "No .vip found in downloaded artifacts."; exit 1 }

          $notes = Get-ChildItem -Path $root -Recurse -Filter "release_notes_*.md" -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $notes) { Write-Error "No release_notes_*.md found in downloaded artifacts."; exit 1 }

          "vip_path=$($vip.FullName)"     | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          "vip_name=$($vip.Name)"         | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          "notes_path=$($notes.FullName)" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          "notes_name=$($notes.Name)"     | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.form-tag.outputs.tag }}
          release_name: ${{ steps.form-tag.outputs.tag }}
          draft: false
          prerelease: false

      - name: Upload .vip to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.locate-artifacts.outputs.vip_path }}
          asset_name: ${{ steps.locate-artifacts.outputs.vip_name }}
          asset_content_type: application/octet-stream

      - name: Upload release notes to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.locate-artifacts.outputs.notes_path }}
          asset_name: ${{ steps.locate-artifacts.outputs.notes_name }}
          asset_content_type: text/markdown

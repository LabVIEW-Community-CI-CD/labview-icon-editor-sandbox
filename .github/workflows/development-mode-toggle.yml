name: "Toggle Development Mode"

defaults:
  run:
    working-directory: ${{ github.workspace }}

on:
  # 1) Called by other workflows
  workflow_call:
    inputs:
      mode:
        description: "Enable or disable dev mode (reusable)."
        type: string
        required: true
        default: "enable"
      bitness:
        description: "Target LabVIEW bitness (32 or 64)."
        type: string
        required: false
        default: "64"
      runner_labels:
        description: "JSON array of runner labels (default: [\"self-hosted-windows-lv\"]). Override in forks with a differently labeled LabVIEW runner."
        type: string
        required: false
        default: "[\"self-hosted-windows-lv\"]"

  # 2) Triggered manually from the Actions tab
  workflow_dispatch:
    inputs:
      mode:
        description: "Enable or disable dev mode (manual)."
        required: true
        default: "enable"
        type: choice
        options:
          - enable
          - disable
      bitness:
        description: "Target LabVIEW bitness (32 or 64)."
        required: false
        default: "64"
        type: choice
        options:
          - "32"
          - "64"
      runner_labels:
        description: "JSON array of runner labels (default: [\"self-hosted-windows-lv\"]). Override in forks with a differently labeled LabVIEW runner."
        required: false
        default: "[\"self-hosted-windows-lv\"]"
        type: string

jobs:
  toggle-dev-mode:
    name: ${{ 
      github.event_name == 'workflow_dispatch' && 
        (github.event.inputs.mode == 'enable' && 'Enable Dev Mode' || 'Disable Dev Mode') || 
        (inputs.mode == 'enable' && 'Enable Dev Mode' || 'Disable Dev Mode') }}
    runs-on: ${{ fromJson( github.event_name == 'workflow_dispatch' && github.event.inputs.runner_labels || inputs.runner_labels ) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          set-safe-directory: true

      - name: Log context
        shell: pwsh
        run: |
          Write-Host "Actor: ${{ github.actor }}"
          Write-Host "Reference: ${{ github.ref }}"
          if ("${{ github.event_name }}" -eq "pull_request") {
            Write-Host "Pull Request Number: ${{ github.event.pull_request.number }}"
          } else {
            Write-Host "Not triggered by a pull request."
          }
            
      - name: ${{
          github.event_name == 'workflow_dispatch' &&
            (github.event.inputs.mode == 'enable' && 'Running Set_Development_Mode.ps1' || 'Running RevertDevelopmentMode.ps1') ||
            (inputs.mode == 'enable' && 'Running Set_Development_Mode.ps1' || 'Running RevertDevelopmentMode.ps1') }}
        id: toggle_dev_mode
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $mode    = '${{ github.event.inputs.mode }}'
            $bitness = '${{ github.event.inputs.bitness }}'
          }
          else {
            $mode    = '${{ inputs.mode }}'
            $bitness = '${{ inputs.bitness }}'
          }

          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            if ($mode -eq 'enable') {
              ./scripts/set-development-mode/Set_Development_Mode.ps1 -RepositoryPath $env:GITHUB_WORKSPACE -SupportedBitness $bitness
            } else {
              ./scripts/revert-development-mode/RevertDevelopmentMode.ps1 -RepositoryPath $env:GITHUB_WORKSPACE -SupportedBitness $bitness
            }
          }
          else {
            if ($mode -eq 'enable') {
              ./scripts/set-development-mode/Set_Development_Mode.ps1 -RepositoryPath $env:GITHUB_WORKSPACE -SupportedBitness $bitness
            } else {
              ./scripts/revert-development-mode/RevertDevelopmentMode.ps1 -RepositoryPath $env:GITHUB_WORKSPACE -SupportedBitness $bitness
            }
          }
      #
      # -- SET OUTPUT (JSON) IF SUCCESS --
      # Using multiline syntax to handle multi-line JSON safely
      #
      - name: Set environment_details output
        if: ${{ success() }}
        id: set_output
        shell: pwsh
        run: |
          # Determine final mode for the JSON output
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            $mode = '${{ github.event.inputs.mode }}'
            $bitness = '${{ github.event.inputs.bitness }}'
          } else {
            $mode = '${{ inputs.mode }}'
            $bitness = '${{ inputs.bitness }}'
          }

          $actor     = '${{ github.actor }}'
          $timestamp = (Get-Date -Format o)  # ISO8601 UTC
          $osInfo    = [System.Environment]::OSVersion.VersionString

          if ('${{ github.event_name }}' -eq 'pull_request') {
            $prNumber = '${{ github.event.pull_request.number }}'
          } else {
            $prNumber = 'N/A'
          }

          # Pretty-printed JSON (multi-line)
          $jsonObject = [ordered]@{
            mode      = $mode
            bitness   = $bitness
            timestamp = $timestamp
            actor     = $actor
            pr_number = $prNumber
            os        = $osInfo
          } | ConvertTo-Json

          Write-Host "JSON Output: $jsonObject"

          # Write multiline output to GITHUB_OUTPUT:
          echo "environment_details<<EOF" >> $env:GITHUB_OUTPUT
          echo "$jsonObject"             >> $env:GITHUB_OUTPUT
          echo "EOF"                     >> $env:GITHUB_OUTPUT

    outputs:
      environment_details: ${{ steps.set_output.outputs.environment_details }}

